slot0 = class("CommanderBreakOutPanel", import("..base.BasePanel"))

slot0.init = function (slot0)
	slot0.starTpl = slot0:getTpl("bg/top/rare/startpl")
	slot0.formStarContainer = slot0:findTF("bg/top/rare/stars_from")
	slot0.toStarContainer = slot0:findTF("bg/top/rare/stars_to")
	slot0.attrContainer = slot0:findTF("bg/top/scroll_rect/content")
	slot0.attrTpl = slot0:getTpl("attr_1", slot0.attrContainer)
	slot0.commanderContainer = slot0:findTF("bg/bottom/materials")
	slot0.commanderTpl = slot0:getTpl("item_1", slot0.commanderContainer)
	slot0.confirmBtn = slot0:findTF("bg/bottom/break_btn")
	slot0.goldTxt = slot0:findTF("tip_active/text", slot0.confirmBtn)
end

slot0.enter = function (slot0, slot1, slot2)
	slot0:update(slot1, slot2)

	if not slot0.isInit then
		slot0.isInit = true

		onButton(slot0, slot0.confirmBtn, function ()
			slot0:emit(CommanderInfoMediator.ON_UPGRADE, slot1.id)
		end, SFX_PANEL)
	end
end

slot0.update = function (slot0, slot1, slot2)
	slot0.commanderVO = slot1
	slot0.commanderVOs = slot2

	slot0:initStarts(slot0.commanderVO, slot0.formStarContainer)

	if slot0.commanderVO:hasNextCommander() then
		slot3 = Clone(slot1)
		slot3.configId = slot0.commanderVO:getNextId()

		slot0:initStarts(slot3, slot0.toStarContainer)
		slot0:updateAttrs(slot1, slot3)
	else
		slot0:updateAttrs(slot1, slot1)
	end

	slot0:updateCommanders()
end

slot0.updateCommanders = function (slot0)
	slot2 = slot0.parent.contextData.upgradeMaterialIds or {}
	slot3, slot4 = slot0.commanderVO:getBreakoutConsume()
	slot5 = slot3[2] or 0

	for slot10 = slot0.commanderContainer.childCount, slot5, 1 do
		cloneTplTo(slot0.commanderTpl, slot0.commanderContainer)
	end

	for slot10 = 1, slot0.commanderContainer.childCount, 1 do
		setActive(slot0.commanderContainer:GetChild(slot10 - 1), slot10 <= slot5)

		if slot10 <= slot5 then
			slot0:updateCommander(slot11, slot2[slot10], slot5)
		end
	end

	setButtonEnabled(slot0.confirmBtn, slot5 ~= 0)
	setActive(slot0.goldTxt.parent, slot5 ~= 0)
	setText(slot0.goldTxt, slot4)
end

slot0.updateCommander = function (slot0, slot1, slot2, slot3)
	setActive(slot0:findTF("icon_bg", slot1), slot2)

	if slot2 then
		updateCommander(slot1, slot0.commanderVOs[slot2], {
			initStar = true
		})
	end

	onButton(slot0, slot1, function ()
		slot0:emit(CommanderInfoMediator.ON_SELECT_MATERIAL_SHIPS, CommanderConst.SELECT_TYPE_UPGRADE, slot0)
	end, SFX_PANEL)
end

slot0.initStarts = function (slot0, slot1, slot2)
	for slot8 = slot2.childCount + 1, slot1:getStar(), 1 do
		cloneTplTo(slot0.starTpl, slot2)
	end

	for slot8 = 1, slot2.childCount, 1 do
		setActive(slot2:GetChild(slot8 - 1), slot8 <= slot4)
	end
end

slot0.updateAttrs = function (slot0, slot1, slot2)
	slot4 = slot2:getProperties()
	slot5 = {}

	for slot9, slot10 in pairs(slot3) do
		if slot4[slot9] ~= slot10 then
			table.insert(slot5, {
				prev = slot10,
				curr = slot11,
				name = slot9
			})
		end
	end

	if #slot5 == 0 then
		for slot9, slot10 in pairs(slot3) do
			table.insert(slot5, {
				prev = slot10,
				curr = slot10,
				name = slot9
			})
		end
	end

	for slot11 = slot0.attrContainer.childCount, #slot5, 1 do
		cloneTplTo(slot0.attrTpl, slot0.attrContainer)
	end

	for slot11 = 1, slot0.attrContainer.childCount, 1 do
		setActive(slot0.attrContainer:GetChild(slot11 - 1), slot11 <= slot6)

		if slot13 then
			slot0:updateAttr(slot12, slot5[slot11])
		end
	end
end

slot0.updateAttr = function (slot0, slot1, slot2)
	setText(slot1:Find("name"), AttributeType.Type2Name(slot2.name))
	setText(slot1:Find("value"), slot2.prev)
	setText(slot1:Find("value1"), slot2.curr)

	if slot2.curr - slot2.prev > 0 then
		setText(slot1:Find("addition"), "(+" .. slot2.curr - slot2.prev .. ")")
	else
		setText(slot1:Find("addition"), "")
	end
end

slot0.exit = function (slot0)
	return
end

return slot0

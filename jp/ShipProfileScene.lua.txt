slot0 = class("ShipProfileScene", import("..base.BaseUI"))
slot0.SHOW_SKILL_INFO = "event show skill info"
slot0.SHOW_EVALUATION = "event show evalution"
slot0.WEDDING_REVIEW = "ShipInfoMediator:WEDDING_REVIEW"
slot0.INDEX_DETAIL = 1
slot0.INDEX_PROFILE = 2
slot0.INDEX_ARCHIVE = 3
slot1 = 0.35
slot2 = 19.8
slot0.CHAT_SHOW_TIME = 3
slot0.CHAT_ANIMATION_TIME = 0.3
slot3 = {}

for slot7, slot8 in pairs(pg.character_voice) do
	slot3[#slot3 + 1] = setmetatable({}, {
		__index = slot8
	})
end

table.sort(slot3, function (slot0, slot1)
	return slot0.profile_index < slot1.profile_index
end)

slot0.getUIName = function (slot0)
	return "ShipProfileUI"
end

slot0.preload = function (slot0, slot1)
	slot5 = getProxy(CollectionProxy).getShipGroup(slot2, slot0.contextData.groupId).groupConfig
	slot6 = getProxy(CollectionProxy).getShipGroup(slot2, slot0.contextData.groupId).shipConfig.rarity

	if slot0.contextData.showTrans and slot3.trans then
		slot6 = slot6 + 1
	end

	GetSpriteFromAtlasAsync("bg/star_level_bg_" .. ((slot3:isBluePrintGroup() and "1") or "") .. shipRarity2bgPrint(slot6, slot0.contextData.groupId * 10 + ((slot0.contextData.showTrans and slot3.trans and 9) or 0)), "", slot1)
end

slot0.setShipGroup = function (slot0, slot1)
	slot0.shipGroup = slot1
	slot0.groupSkinList = ShipGroup.getSkinList(slot0.shipGroup.id)
	slot0.currentSkin = slot0.groupSkinList[1]
	slot0.currentSkinWord = pg.ship_skin_words[slot0.currentSkin.id]

	if slot0.currentSkinWord.voice_key >= 0 then
		pg.CriMgr:LoadCV(slot2, slot3)
		pg.CriMgr:LoadBattleCV(Ship.getCVKeyID(slot0.currentSkin.id), function ()
			if slot1.exited then
				pg.CriMgr.UnloadCVBank(slot0)
				pg.CriMgr.UnloadCVBank(slot1)
			else
				slot1.loadedCVBankName = slot0
				slot1.loadedCVBattleBankName = slot1
			end
		end)
	end
end

slot0.setShowTrans = function (slot0, slot1)
	slot0.showTrans = slot1
end

slot0.setOwnedSkinList = function (slot0, slot1)
	slot0.ownedSkinList = slot1
end

slot0.flushHearts = function (slot0)
	SetActive(slot0.labelHeartplus, slot0.shipGroup.hearts > 999)
	setText(slot0.labelHeart, (slot1 > 999 and "999") or slot1)

	slot0.labelHeart:GetComponent("Text").color = (slot0.shipGroup.iheart and Color.New(1, 0.6, 0.6)) or Color.New(1, 1, 1)

	setActive(slot0:findTF("unlike", slot0.btnLike), not slot0.shipGroup.iheart)
	setActive(slot0:findTF("like", slot0.btnLike), slot0.shipGroup.iheart)
end

slot0.init = function (slot0)
	slot0.bg = slot0:findTF("bg")
	slot0.painting = slot0:findTF("paint")
	slot0.chat = slot0:findTF("chat", slot0.painting)
	slot0.chatBg = slot0:findTF("chatbgtop", slot0.chat)
	slot0.initChatBgH = slot0.chatBg.sizeDelta.y
	slot0.chatText = slot0:findTF("Text", slot0.chatBg)
	slot0.chat.localScale = Vector3(0, 0)

	setActive(slot0.chat, false)

	slot0.name = slot0:findTF("name")
	slot0.labelName = slot0:findTF("Text", slot0.name)
	slot0.labelEnName = slot0:findTF("english_name", slot0.name)
	slot0.shipType = slot0:findTF("ship_type/type", slot0.name)
	slot0.stars = slot0:findTF("stars", slot0.name)
	slot0.star = slot0:findTF("star_tpl", slot0.stars)
	slot0.btnBack = slot0:findTF("top/back")
	slot0.leftProfile = slot0:findTF("profile_left_panel")
	slot0.profile = slot0:findTF("profile_panel")
	slot0.live2dBtn = slot0:findTF("L2D_btn")
	slot0.live2dToggle = slot0.live2dBtn:Find("toggle")
	slot0.live2dState = slot0.live2dBtn:Find("state")
	slot0.toggles = {
		slot0:findTF("bottom/detail"),
		slot0:findTF("bottom/profile"),
		slot0:findTF("bottom/archive")
	}
	slot0.toggleInits = {
		"initDetail",
		"initProfile",
		"initArchive"
	}

	setActive(slot0.star, false)

	slot0.top = slot0:findTF("top")
end

slot0.uiStartAnimating = function (slot0)
	setAnchoredPosition(slot0.top, {
		y = 83
	})
	shiftPanel(slot0.top, nil, 0, slot2, slot1, true, true)

	slot0.tweens = topAnimation(slot0:findTF("bg/left", slot0.top), slot0:findTF("bg/right", slot0.top), slot0:findTF("bg/title_data", slot0.top), slot0:findTF("bg/profile", slot0.top), 0.3, function ()
		slot0.tweens = nil
	end)
end

slot0.uiExitAnimating = function (slot0)
	shiftPanel(slot0.top, nil, 83, 0.3, 0, true, true)
end

slot0.didEnter = function (slot0)
	slot0:uiStartAnimating()
	onButton(slot0, slot0.btnBack, function ()
		slot0:uiExitAnimating()
		slot0.uiExitAnimating:emit(slot1.ON_BACK, nil, 0.3)
	end, SFX_CANCEL)

	for slot4, slot5 in ipairs(slot0.toggles) do
		onToggle(slot0, slot5, function (slot0)
			if slot0 ~= 2 then
				slot1:switchLive2d(false)
			end

			if slot0 >= 3 and slot0 then
				pg.TipsMgr.GetInstance():ShowTips(i18n("word_systemClose"))
				triggerToggle(slot1.toggles[1], true)

				return
			end

			if slot0 then
				if slot1.toggleInits[slot0] then
					slot1[slot1.toggleInits[slot0]](slot1[slot1.toggleInits[slot0]])

					slot1[slot1.toggleInits[slot0]].toggleInits[slot0] = nil
				end

				slot1:switchTo(slot0)
			end
		end, SFX_PANEL)
	end

	slot0:initCommon()
	triggerToggle(slot0.toggles[1], true)
	slot0:switchLive2d(false)
end

slot0.onBackPressed = function (slot0)
	if LeanTween.isTweening(go(slot0.painting)) then
		return
	end

	playSoundEffect(SFX_CANCEL)

	if slot0.paintPreview then
		slot0:hidePaintView(true)

		return
	end

	triggerButton(slot0.btnBack)
end

slot0.switchLive2d = function (slot0, slot1)
	slot2 = "live2d/" .. slot0.paintingName

	if Live2DUpdateMgr.Inst.state == DownloadState.None or slot4 == DownloadState.CheckFailure then
		slot3:CheckD()
	end

	if slot3:CheckF(slot2) == DownloadState.CheckToUpdate or slot5 == DownloadState.UpdateFailure then
		setActive(slot0.live2dBtn, true)
		setActive(slot0.live2dState, false)
		setActive(slot0.live2dToggle, true)
		setActive(slot0.live2dToggle:Find("on"), false)
		setActive(slot0.live2dToggle:Find("off"), true)
		onButton(slot0, slot0.live2dBtn, function ()
			slot0:UpdateF(slot0, true)
		end, SFX_PANEL)
	elseif slot5 == DownloadState.Updating then
		setActive(slot0.live2dBtn, true)
		setActive(slot0.live2dToggle, false)
		setActive(slot0.live2dState, true)
		removeOnButton(slot0.live2dBtn)
	else
		setActive(slot0.live2dBtn, PathMgr.FileExists(PathMgr.getAssetBundle(slot2)))

		if PathMgr.FileExists(PathMgr.getAssetBundle(slot2)) then
			slot0.live2dChecked = slot1

			setActive(slot0.live2dState, false)
			setActive(slot0.live2dToggle, true)
			setActive(slot0.live2dToggle:Find("on"), slot0.live2dChecked)
			setActive(slot0.live2dToggle:Find("off"), not slot0.live2dChecked)
			setActive(slot0:findTF("view_btn", slot0.profile), not slot0.live2dChecked)

			if slot0.live2dChecked then
				slot0:createLive2D(slot0.paintingName)
			else
				slot0:hideLive2D()
			end

			onButton(slot0, slot0.live2dBtn, function ()
				slot0:switchLive2d(not slot0.live2dChecked)
			end, SFX_PANEL)
		end
	end

	if slot0.live2dTimer then
		slot0.live2dTimer:Stop()

		slot0.live2dTimer = nil
	end

	if slot5 == DownloadState.CheckToUpdate or slot5 == DownloadState.UpdateFailure or slot5 == DownloadState.Updating then
		slot0.live2dTimer = Timer.New(function ()
			slot0:switchLive2d((slot0:CheckF(slot0) == DownloadState.UpdateSuccess and true) or slot3)
		end, 0.5, 1)

		slot0.live2dTimer:Start()
	end
end

slot0.switchTo = function (slot0, slot1)
	if slot0.index ~= slot1 then
		if slot1 == slot0.INDEX_DETAIL then
			LeanTween.moveX(rtf(slot0.detailLeft), 0, slot1):setEase(LeanTweenType.easeInOutSine)
			LeanTween.moveX(rtf(slot0.detailRight), 0, slot1):setEase(LeanTweenType.easeInOutSine)
			LeanTween.moveX(rtf(slot0.profile), 680, slot1):setEase(LeanTweenType.easeInOutSine)
			LeanTween.moveX(rtf(slot0.leftProfile), -265, slot1):setEase(LeanTweenType.easeInOutSine)
			LeanTween.moveY(rtf(slot0.live2dBtn), -70, slot1):setEase(LeanTweenType.easeInOutSine)
		end

		if slot1 == slot0.INDEX_PROFILE then
			LeanTween.moveX(rtf(slot0.profile), 0, slot1):setEase(LeanTweenType.easeInOutSine)
			LeanTween.moveX(rtf(slot0.leftProfile), 0, slot1):setEase(LeanTweenType.easeInOutSine)
			LeanTween.moveX(rtf(slot0.detailRight), 680, slot1):setEase(LeanTweenType.easeInOutSine)
			LeanTween.moveY(rtf(slot0.live2dBtn), 60, slot1):setEase(LeanTweenType.easeInOutSine)
		end

		slot0.index = slot1
	end
end

slot0.initCommon = function (slot0)
	slot0:loadSkinBg(shipRarity2bgPrint(slot0.shipGroup:getRarity(slot0.showTrans), slot0.shipGroup.id * 10))

	slot0.paintingName = slot0.shipGroup:getPainting(slot0.showTrans)
	slot0.live2dOffset = BuildVector3(pg.ship_skin_template[slot0.shipGroup.id * 10 + ((slot0.showTrans and 9) or 0)].live2d_offset)

	setPaintingPrefabAsync(slot0.painting, slot0.paintingName, "chuanwu", function ()
		Ship.SetExpression(findTF(slot0.painting, "fitter"):GetChild(0), slot0.paintingName)
	end)
	setImageSprite(slot0.shipType, GetSpriteFromAtlas("shiptype", slot0.shipGroup:getShipType(slot0.showTrans)))
	setText(slot0.labelName, slot0.shipGroup:getName(slot0.showTrans))
	setText(slot0.labelEnName, slot0.shipGroup.shipConfig.english_name)

	for slot8 = 1, slot1.star, 1 do
		cloneTplTo(slot0.star, slot0.stars)
	end
end

slot0.initDetail = function (slot0)
	slot0.detailLeft = slot0:findTF("detail_left_panel")
	slot0.lockBtn = slot0:findTF("lock_btn", slot0.detailLeft)
	slot0.unlockBtn = slot0:findTF("unlock_btn", slot0.detailLeft)
	slot0.labelHeart = slot0:findTF("heart/label/heart", slot0.detailLeft)
	slot0.labelHeartplus = slot0:findTF("heart/label/heart+", slot0.detailLeft)
	slot0.btnLike = slot0:findTF("heart/btnLike", slot0.detailLeft)
	slot0.detailRight = slot0:findTF("detail_right_panel")
	slot0.viewBtn = slot0:findTF("view_btn", slot0.detailRight)
	slot0.evaBtn = slot0:findTF("eva_btn", slot0.detailRight)
	slot0.shareBtn = slot0:findTF("share_btn", slot0.detailRight)
	slot0.skillContainer = slot0:findTF("bg/skill_panel/frame/skill_list/viewport/content", slot0.detailRight)
	slot0.skillTpl = slot0:getTpl("bg/skill_panel/frame/skilltpl", slot0.detailRight)
	slot0.emptyTpl = slot0:getTpl("bg/skill_panel/frame/emptytpl", slot0.detailRight)
	slot0.addTpl = slot0:getTpl("bg/skill_panel/frame/addtpl", slot0.detailRight)

	slot0:flushHearts()
	slot0:initSkills()

	slot0.propertyPanel = PropertyPanel.New(slot0.detailRight:Find("bg/property_panel/frame"))

	if slot0.showTrans and slot0.shipGroup.trans then
		slot0.propertyPanel:initRadar(slot0.shipGroup.groupConfig.trans_radar_chart)
	else
		slot0.propertyPanel:initProperty(slot0.shipGroup.shipConfig.id)
	end

	setActive(slot0.evaBtn, not slot0.showTrans)
	onButton(slot0, slot0.viewBtn, function ()
		slot0:paintView()
	end, SFX_PANEL)
	onButton(slot0, slot0.evaBtn, function ()
		slot0:emit(slot1.SHOW_EVALUATION)
	end, SFX_PANEL)
	onButton(slot0, slot0.shareBtn, function ()
		pg.ShareMgr.GetInstance():Share(pg.ShareMgr.TypeShipProfile)
	end, SFX_PANEL)
end

slot0.initSkills = function (slot0)
	slot2 = 0
	slot3 = Clone(pg.ship_data_template[slot0.shipGroup.shipConfig.id].buff_list_display)

	if not slot0.showTrans then
		_.each(slot0.shipGroup.groupConfig.trans_skill, function (slot0)
			table.removebyvalue(slot0, slot0)
		end)
	end

	for slot7, slot8 in ipairs(slot3) do
		onButton(slot0, slot10, function ()
			slot0:emit(slot1.SHOW_SKILL_INFO, slot2.id, {
				id = slot2.id,
				level = pg.skill_data_template[slot2.id].max_level
			})
		end, SFX_PANEL)

		slot2 = slot2 + 1

		LoadImageSpriteAsync("skillicon/" .. getSkillConfig(slot8).icon, findTF(cloneTplTo(slot0.skillTpl, slot0.skillContainer), "icon"))
	end

	for slot7 = 1, 3 - slot2, 1 do
		cloneTplTo(slot0.addTpl, slot0.skillContainer)
	end

	if slot2 > 3 then
		slot0.skillContainer.pivot = Vector2.New(0, 1)
		slot0.skillContainer.anchoredPosition = Vector2.zero
	end
end

slot0.paintView = function (slot0)
	slot1 = {}
	slot2 = slot0._tf.childCount
	slot3 = 0

	while slot2 > slot3 do
		if slot0._tf:GetChild(slot3).gameObject.activeSelf and slot4 ~= slot0.painting and slot4 ~= slot0.bg then
			slot1[#slot1 + 1] = slot4

			setActive(slot4, false)
		end

		slot3 = slot3 + 1
	end

	slot0.painting:GetComponent("CanvasGroup").blocksRaycasts = false
	slot5 = slot0.painting.anchoredPosition.x
	slot6 = slot0.painting.anchoredPosition.y
	slot9 = slot0._tf.rect.width / UnityEngine.Screen.width
	slot10 = slot0._tf.rect.height / UnityEngine.Screen.height
	slot11 = slot0.painting.rect.width / 2
	slot12 = slot0.painting.rect.height / 2
	slot14 = slot0.painting:Find("fitter"):GetChild(0)

	LeanTween.moveX(slot0.painting, 0, 0.3):setEase(LeanTweenType.easeInOutSine):setOnComplete(System.Action(function ()
		openPortrait()

		slot1 = false
		slot2, slot3 = nil
		slot4 = GetOrAddComponent(slot0.bg, "MultiTouchZoom")

		slot4:SetZoomTarget(slot0.painting)

		slot5 = GetOrAddComponent(slot0.bg, "EventTriggerListener")
		slot0.dragTrigger = slot5
		slot4.enabled = true
		slot5.enabled = true

		slot5:AddPointDownFunc(function (slot0)
			if Input.touchCount == 1 or Application.isEditor then
				slot0 = true
				slot1 = true
			elseif Input.touchCount >= 2 then
				slot1 = false
				slot0 = false
			end
		end)
		slot5:AddPointUpFunc(function (slot0)
			if Input.touchCount <= 2 then
				slot0 = true
			end
		end)
		slot5:AddBeginDragFunc(function (slot0, slot1)
			slot0 = false
			slot5 = slot1.position.x *  - slot1.position.x - tf(slot4.painting).localPosition.x.position.y * slot6 - slot7 - tf(slot4.painting.painting).localPosition.y
		end)
		slot5:AddDragFunc(function (slot0, slot1)
			if slot0 then
				tf(slot1.painting).localPosition = Vector3(slot1.position.x * slot2 - slot3 - slot4, slot1.position.y * slot5 -  - slot1.position.y * slot5, -22)
			end
		end)

		slot0.bg:GetComponent("Button").enabled = true

		onButton(slot0, slot0.bg, function ()
			slot0:hidePaintView()
		end, SFX_CANCEL)

		slot5.hidePaintView = function (slot0, slot1)
			if not slot1 and not slot0 then
				return
			end

			slot1.enabled = false
			slot1.enabled = false

			for slot5, slot6 in ipairs(false) do
				setActive(slot6, true)
			end

			closePortrait()

			slot0.painting.localScale = Vector3(1, 1, 1)

			setAnchoredPosition(slot0.painting, {
				x = slot4,
				y = slot4
			})

			slot0.bg:GetComponent("Button").enabled = false
			slot6.blocksRaycasts = true
			slot0.paintPreview = false
		end
	end))

	slot0.paintPreview = true
end

slot0.initProfile = function (slot0)
	slot0.authorPanel = slot0:findTF("bg/author_panel", slot0.profile)
	slot0.linesPanel = slot0:findTF("bg/lines_panel", slot0.profile)
	slot0.prototypePanel = slot0:findTF("bg/prototype_panel", slot0.profile)

	slot0:clearScrollTxt()
	setActive(slot0.chat, true)

	slot0.chat.localScale = Vector3(0, 0)
	slot0.voiceTpl = slot0:getTpl("frame/lines_list/lines_tpl", slot0.linesPanel)
	slot0.voiceContainer = slot0:findTF("frame/lines_list/Grid", slot0.linesPanel)
	slot0.voiceScroll = slot0:findTF("frame/lines_list", slot0.linesPanel).gameObject:GetComponent(typeof(ScrollRect))
	slot1 = 1

	if slot0.showTrans then
		slot2 = ShipGroup.getModSkin(slot0.shipGroup.id).id

		for slot6, slot7 in ipairs(slot0.groupSkinList) do
			if slot7.id == slot2 then
				slot1 = slot6

				break
			end
		end
	end

	setText(slot0:findTF("bg/author_panel/illustrator/Text", slot0.profile), Nation.Nation2facionName(slot2) .. "-" .. Nation.Nation2Name(slot0.shipGroup.shipConfig.nationality))
	slot0:shiftSkin(slot1)
	slot0:setProfileInfo()

	slot0.skinList = slot0:findTF("skin_container", slot0.leftProfile)

	if #slot0.groupSkinList == 1 or slot0.showTrans then
		setActive(slot0.skinList, false)
	else
		setActive(slot0.skinList, true)

		slot3 = slot0:getTpl("skin_tpl", slot0.skinList)

		for slot7, slot8 in ipairs(slot0.groupSkinList) do
			table.insert(slot0.skinNameList, ScrollTxt.New(findTF(slot9, "mask"), findTF(slot9, "mask/Text")))

			if slot8.skin_type == Ship.SKIN_TYPE_DEFAULT or table.contains(slot0.ownedSkinList, slot8.id) or (slot8.skin_type == Ship.SKIN_TYPE_REMAKE and slot0.shipGroup.trans) or (slot8.skin_type == Ship.SKIN_TYPE_PROPOSE and slot0.shipGroup.married == 1) then
				slot10:setText(HXSet.hxLan(slot8.name))
				onButton(slot0, slot9, function ()
					slot0:shiftSkin(slot0)
				end)
			else
				slot10:setText(HXSet.hxLan(slot8.name))
				onButton(slot0, slot9, function ()
					pg.TipsMgr:GetInstance():ShowTips(i18n("ship_profile_skin_locked"))
				end)
			end
		end
	end

	slot3 = slot0:findTF("bg/wedding", slot0.profile)

	if slot0.shipGroup.married == 1 then
		setActive(slot3, true)
		onButton(slot0, slot3, function ()
			slot0:emit(slot1.WEDDING_REVIEW, {
				groupID = slot0.shipGroup.id,
				skinID = slot0.currentSkin.id
			})
		end)
	elseif slot0.shipGroup.married == 0 then
		setActive(slot3, false)
	end

	onButton(slot0, slot0:findTF("view_btn", slot0.profile), function ()
		slot0:paintView()
	end, SFX_PANEL)

	if not slot0.showTrans then
		onButton(slot0, slot0:findTF("eva_btn", slot0.profile), function ()
			slot0:emit(slot1.SHOW_EVALUATION)
		end, SFX_PANEL)
	end

	setActive(slot0:findTF("eva_btn", slot0.profile), not slot0.showTrans)
	onButton(slot0, slot0:findTF("share_btn", slot0.profile), function ()
		pg.ShareMgr.GetInstance():Share(pg.ShareMgr.TypeShipProfile)
	end, SFX_PANEL)
end

slot0.shiftSkin = function (slot0, slot1)
	slot0.currentSkin = slot0.groupSkinList[slot1]
	slot0.currentSkinWord = pg.ship_skin_words[slot0.currentSkin.id]

	slot0:setAuthorInfo(slot0.currentSkin.voice_actor, slot0.currentSkin.illustrator)
	removeAllChildren(slot0.voiceContainer)

	if slot0._currentVoice then
		slot0._currentVoice:Stop(true)
	end

	for slot5, slot6 in ipairs(slot0) do
		if not pg.AssistantInfo.isDisableSpecialClick(slot6.key) then
			slot0:appendVoiceButton(slot6)
		end
	end

	slot0.voiceScroll.enabled = false
	slot0.voiceScroll.enabled = true

	LeanTween.cancel(slot0.chat.gameObject)

	slot0.chat.localScale = Vector3(0, 0)

	slot0:loadModel()
	slot0:shiftPainting()
	slot0:loadSkinBg((slot0.currentSkin.bg and #slot0.currentSkin.bg > 0 and slot0.currentSkin.bg) or shipRarity2bgPrint(slot0.shipGroup:getRarity(slot0.showTrans), slot0.currentSkin.id))
	slot0:switchLive2d(false)
end

slot0.loadSkinBg = function (slot0, slot1)
	slot0.isDesign = slot0.shipGroup:isBluePrintGroup()

	if slot0.shipSkinBg ~= slot1 then
		slot0.shipSkinBg = slot1

		GetSpriteFromAtlasAsync("bg/star_level_bg_" .. ((slot0.isDesign and "1") or "") .. slot1, "", function (slot0)
			if not slot0.exited and slot0.shipSkinBg ==  then
				setImageSprite(slot0.bg, slot0)
			end
		end)

		if slot0.isDesign then
			if not slot0.designBg then
				PoolMgr.GetInstance():GetUI("raritydesign5", true, function (slot0)
					slot0.designBg = slot0

					slot0.transform:SetParent(slot0._tf, false)

					slot0.transform.localPosition = Vector3(1, 1, 1)
					slot0.transform.localScale = Vector3(1, 1, 1)

					slot0.transform:SetSiblingIndex(1)
					setActive(slot0, true)
				end)
			else
				setActive(slot0.designBg, true)
			end
		elseif slot0.designBg then
			setActive(slot0.designBg, slot0.isDesign)
		end
	end
end

slot0.shiftPainting = function (slot0)
	if slot0.currentSkin.painting == slot0.paintingName then
		return
	end

	if slot0.paintingName then
		retPaintingPrefab(slot0.painting, slot0.paintingName)
	end

	slot0.paintingName = slot0.currentSkin.painting
	slot0.live2dOffset = BuildVector3(slot0.currentSkin.live2d_offset)

	setPaintingPrefabAsync(slot0.painting, slot0.paintingName, "chuanwu")
end

slot0.loadModel = function (slot0)
	slot1 = slot0:findTF("model", slot0.leftProfile)

	if not IsNil(slot0.characterModel) then
		PoolMgr.GetInstance():ReturnSpineChar(slot0.modelName, slot0.characterModel)
	end

	PoolMgr.GetInstance():GetSpineChar(slot0.currentSkin.prefab, true, function (slot0)
		slot0.name = slot0
		slot0.transform.localPosition = Vector3.zero
		slot0.transform.localScale = Vector3(0.4, 0.4, 1)

		slot0.transform:SetParent(slot0.transform.SetParent, false)
		slot0:GetComponent(typeof(SpineAnimUI)).SetAction(slot2, slot2.currentSkin.show_skin or "stand", true)

		slot2.characterModel = slot0
		slot2.modelName = slot0
	end)
end

slot0.setAuthorInfo = function (slot0, slot1, slot2, slot3)
	slot4 = nil

	setText(slot0:findTF("cv/Text", slot0.authorPanel), (slot1 == -1 and "-") or pg.voice_actor_CN[slot1].actor_name)
end

slot0.setProfileInfo = function (slot0)
	slot5, slot2 = Ship.getWords(slot0.currentSkin.id, "profile")

	setText(slot0:findTF("frame/description/desc/Text", slot0.prototypePanel), slot1)

	slot3 = slot0:findTF("playButton", slot0.prototypePanel)

	if slot0.currentSkinWord.voice_key >= 0 then
		setActive(slot3, true)
		onButton(slot0, slot3, function ()
			if slot0._currentVoice then
				slot0._currentVoice:Stop(true)
			end

			slot0._currentVoice = playSoundEffect(playSoundEffect)
		end)
	else
		setActive(slot3, false)
	end
end

slot0.CONDITION_FORBIDDEN = -1
slot0.CONDITION_CLEAR = 0
slot0.CONDITION_INTIMACY = 1
slot0.CONDITION_MARRIED = 2

slot0.voiceReplayCodition = function (slot0, slot1)
	slot2 = true
	slot3 = ""

	if slot0.shipGroup:isBluePrintGroup() and not table.contains(getProxy(TechnologyProxy):getBluePrintById(slot0.shipGroup.id).getUnlockVoices(slot4), slot1.key) and slot4:getUnlockLevel(slot1.key) > 0 then
		return false, i18n("ship_profile_voice_locked_design", slot6)
	end

	if slot1.unlock_condition[1] == slot0.CONDITION_INTIMACY then
		if slot0.shipGroup.maxIntimacy < slot1.unlock_condition[2] then
			slot2 = false
			slot3 = i18n("ship_profile_voice_locked_intimacy", math.floor(slot1.unlock_condition[2] / 100))
		end
	elseif slot1.unlock_condition[1] == slot0.CONDITION_MARRIED and slot0.shipGroup.married == 0 then
		slot2 = false
		slot3 = i18n("ship_profile_voice_locked_propose")
	end

	return slot2, slot3
end

slot0.appendVoiceButton = function (slot0, slot1)
	slot2 = slot1.key

	if slot1.unlock_condition[1] < 0 or slot0.currentSkinWord[slot2] == "" then
		return
	end

	slot3 = nil

	if string.find(slot2, "main") and (string.split(slot0.currentSkinWord.main, "|")[tonumber(string.split(slot2, "main")[1])] == nil or slot5 == "nil") then
		return
	end

	setActive(slot4, true)

	slot5, slot6 = slot0:voiceReplayCodition(slot1)

	if slot5 then
		setText(slot0:findTF("Text", slot4), slot1.voice_name)
	else
		setText(slot0:findTF("Text", slot4), "???")
	end

	onButton(slot0, slot4, function ()
		if slot0 then
			slot1:showChat(slot2, slot3)

			if slot1.characterModel then
				slot0 = nil

				slot1.characterModel:GetComponent(typeof(SpineAnimUI)):SetAction((slot4.spine_action == "" and "stand") or slot4.spine_action, 0)
			end

			if slot1.live2dChecked and slot1.l2dChar then
				slot1.l2dChar:SetAction(pg.AssistantInfo.action2Id[slot4.l2d_action])
			end
		else
			pg.TipsMgr:GetInstance():ShowTips(slot5)
		end
	end)
end

slot0.showChat = function (slot0, slot1, slot2)
	slot3, slot4 = nil

	if slot2 then
		if findTF(slot0.painting, "fitter").childCount > 0 then
			Ship.SetExpression(findTF(slot0.painting, "fitter"):GetChild(0), slot0.paintingName, "main_" .. slot2)
		end

		slot3, slot4 = Ship.getWords(slot0.currentSkin.id, "main", slot2)
	else
		if findTF(slot0.painting, "fitter").childCount > 0 then
			Ship.SetExpression(findTF(slot0.painting, "fitter"):GetChild(0), slot0.paintingName, slot1)
		end

		slot3, slot4 = Ship.getWords(slot0.currentSkin.id, slot1)
	end

	delayTime = slot0.CHAT_SHOW_TIME

	if slot0.currentSkinWord.voice_key >= 0 then
		if slot0._currentVoice then
			slot0._currentVoice:Stop(true)
		end

		slot5 = nil
		slot0._currentVoice, slot5 = playSoundEffect(slot4)

		if slot7 then
			delayTime = long2int(slot5.length) * 0.001
		end
	end

	setText(slot0.chatText, slot3)

	if CHAT_POP_STR_LEN < #slot0.chatText:GetComponent(typeof(Text)).text then
		slot5.alignment = TextAnchor.MiddleLeft
	else
		slot5.alignment = TextAnchor.MiddleCenter
	end

	if slot0.initChatBgH < slot5.preferredHeight + 26 then
		slot0.chatBg.sizeDelta = Vector2.New(slot0.chatBg.sizeDelta.x, slot6)
	else
		slot0.chatBg.sizeDelta = Vector2.New(slot0.chatBg.sizeDelta.x, slot0.initChatBgH)
	end

	LeanTween.cancel(slot0.chat.gameObject)

	slot0.chat.localScale = Vector3(0, 0)

	LeanTween.scale(rtf(slot0.chat.gameObject), Vector3.New(1, 1, 1), slot0.CHAT_ANIMATION_TIME):setEase(LeanTweenType.easeOutBack):setOnComplete(System.Action(function ()
		LeanTween.scale(rtf(slot0.chat.gameObject), Vector3.New(0, 0, 1), slot0.CHAT_ANIMATION_TIME):setEase(LeanTweenType.easeInBack):setDelay(slot0.CHAT_ANIMATION_TIME + delayTime)
	end))
end

slot0.createLive2D = function (slot0, slot1)
	setActive(slot0.painting:Find("fitter"), false)

	if slot0.live2dRoot then
		pg.Live2DMgr.GetInstance():AddRefCount(slot0.l2dChar.name)
		Destroy(slot0.live2dRoot)

		slot0.live2dRoot = nil
		slot0.l2dChar = nil
	end

	pg.Live2DMgr.GetInstance():GetLive2DModelAsync(slot1, function (slot0)
		if slot0.exited then
			Destroy(slot0)

			return
		end

		slot1 = slot0:findTF("live2d", slot0.painting)
		slot0.live2dRoot = UIUtil.AddCameraTexture(slot2, 1536, 15, LayerMask.NameToLayer("UI"))

		UIUtil.SetLayerRecursively(slot0, LayerMask.NameToLayer("UI"))
		slot0.transform.SetParent(slot3, slot0.live2dRoot.transform, false)

		slot0.transform.localPosition = Vector3(0, -0.8, 0) + slot0.live2dOffset

		slot0.live2dRoot.transform:SetParent(slot0.painting, true)

		slot0.live2dRoot.name = "live2dRoot"
		slot0.l2dChar = GetComponent(slot0, "Live2dChar")
		slot0.l2dChar.name = slot1

		slot0.l2dChar.FinishAction = function (slot0)
			if slot0 ~= slot0 then
				slot1.l2dChar:SetAction(slot0)
			end
		end

		slot0.l2dChar:SetAction(slot4)
		setActive(slot1, true)
	end)
end

slot0.hideLive2D = function (slot0)
	setActive(slot0.painting:Find("fitter"), true)

	if slot0.live2dRoot then
		setActive(slot0:findTF("live2d", slot0.painting), false)
	end
end

slot0.clearScrollTxt = function (slot0)
	if slot0.skinNameList ~= nil and #slot0.skinNameList > 0 then
		for slot4, slot5 in ipairs(slot0.skinNameList) do
			slot5:destroy()
		end
	end

	slot0.skinNameList = {}
end

slot0.willExit = function (slot0)
	slot0:clearScrollTxt()

	if slot0.dragTrigger then
		ClearEventTrigger(slot0.dragTrigger)

		slot0.dragTrigger = nil
	end

	if slot0.tweens then
		cancelTweens(slot0.tweens)
	end

	if slot0.paintingName then
		retPaintingPrefab(slot0.painting, slot0.paintingName)

		slot0.paintingName = nil
		slot0.live2dOffset = nil
	end

	cameraPaintViewAdjust(false)

	if slot0.loadedCVBankName then
		pg.CriMgr.UnloadCVBank(slot0.loadedCVBankName)

		slot0.loadedCVBankName = nil
	end

	if slot0.loadedCVBattleBankName then
		pg.CriMgr.UnloadCVBank(slot0.loadedCVBattleBankName)

		slot0.loadedCVBattleBankName = nil
	end

	if not IsNil(slot0.characterModel) then
		PoolMgr.GetInstance():ReturnSpineChar(slot0.modelName, slot0.characterModel)
	end

	if slot0.l2dChar then
		slot0.l2dChar:ClearPics()
		pg.Live2DMgr.GetInstance():TryReleaseLive2dRes(slot0.l2dChar.name)

		slot0.l2dChar = nil
	end

	slot0.live2dRoot = nil

	if slot0.live2dTimer then
		slot0.live2dTimer:Stop()

		slot0.live2dTimer = nil
	end
end

return slot0
